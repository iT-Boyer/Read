# ElasticSearch 实战

# 2. 深入功能

es中的数据是如何组织起来的

逻辑设计: 搜索应用所要注意的

- 用于索引和搜索的基本单位是文档, 可以将其理解为数据库的一行
- 文档以类型来分组, 类型包含若干文档, 类似表格包含若干行
- 一个或多个类型存在同一索引里, 类似SQL的数据库

物理设计: Es是如何处理数据的

- ES将每个索引划分片, 每份分片可以在集群中的不同服务间迁移

## 2.1 理解逻辑设计: 文档、类型和索引

### 2.1.1 文档

文档的重要属性

- 文档是自我包含的. 一篇文档同时包含字段(如name), 和它的取值(如es denver)
- 文档是层次型的. 文档中还可以包含文档
- 文档拥有灵活的结构. 文档并不依赖预先定义的模式, 例如并非所有的活动都需要`描述`这个字段值, 所以可以彻底忽略该字段

### 2.1.2 类型

类型是文档的逻辑容器, 类似于表格是行的容器

在不同类型中, 最好放入不同的结构的文档

例如可以一个类型定义聚会时的分组, 一个类型定义人们参加的活动

每个类型中字段的定义称为映射, 例如name的字段称为string

而location中的geolocation字段映射是geo_point

每个映射的搜索处理方式不一样

例如string映射可以搜索关键字, 而geo_point映射可以搜索哪个分组离你更近

如果一篇新旧索引的文档拥有一个映射尚不存在的字段, es会自动将新字段加入映射

es会对字段进行猜测映射, 例如值是7 就会猜测是长整型

假如索引了值7之后, 可能再想索引`hello world`, 索引就会失败

对于线上的环境, 最安全的方式是在索引数据之前, 就定义好好所需的映射

### 2.1.3 索引

索引是映射类型的容器, 一个es索引非常像关系型世界的数据库, 是独立的大量文档集合

每个索引存储在磁盘的同组文件中

所以存储了所有映射类型的字段, 还有一些设置

例如`refresh_interval`设置, 定义新近索引的文档对于搜索可见的时机间隔

`刷新`操作比较昂贵, 默认是每秒更新一次, 而不是每来一篇新的文档更新一次

可以设置某个索引的分片的数量, 索引是由一个/多个分片的数据块组成

## 2.2 理解物理设置: 节点和分片

一个索引创建时, 默认每个索引由5个主要分片组成, 而每个主要分片又有一个副本, 一共10份分片

一个分片是一个目录中的文件, 分片也是es将数据从一个节点移到另一个节点的最小单位

默认情况下, 可以连接集群中的任一节点并访问完整的数据集, 就好像集群只有单独的一个节点

> 当索引一篇文档时发生了什么

- 系统根据文档id的散列值选择一个主分片, 并把文档发送到该主分片
- 这份主分片可能存在位于另一个节点
- 然后文档被发送到该主分片的所有副本分片进行索引
- 在主分片无法访问时, 副分片自动升级为主分片

> 搜索索引时发生了什么

es需要在该索引的完整分片集合中进行查找, 这些分片可以是主分片/副分片

### 2.2.2 理解主分片和副本分片

es所处理的最小单元: 分片

一个分片是Lucene的索引

一个包含倒排索引的文件目录

倒排索引的结构使得es不扫描所有的文档情况下, 就能告知你哪些文档包含特定的词条

副本分片可以在运行时进行添加和删除, 而主分片不行

在创建索引之前, 必须决定分片的数量

过少的分片限制可扩展性, 过多的分片会影响性能, 默认为5是个不错的开始

## 2.3 索引新数据

手动索引第一篇文档, 使用`put`请求

`http://location:9200/get-together/group/1`

- get-together为索引名称
- group为类型的名称
- 1位文档id



